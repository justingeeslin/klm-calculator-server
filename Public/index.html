<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>KLM Calculator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
	  /* 1) Default (light) theme via CSS variables */
	  :root {
		--bg: #ffffff;
		--text: #111111;
		--muted: #666666;
		--panel: #f5f5f7;
		--border: #d0d0d0;
		--input-bg: #ffffff;
		--focus: #3f8cff;
		--button-bg: #3f8cff;
		--button-bg-hover: #2f6edb;
		--mono-output: #0b5; /* greenish success */
	  }
	  
	  /* 2) Auto-switch to dark when the OS is in dark mode */
	  @media (prefers-color-scheme: dark) {
		:root {
		  --bg: #121212;
		  --text: #e0e0e0;
		  --muted: #bbbbbb;
		  --panel: #1a1a1a;
		  --border: #333333;
		  --input-bg: #1e1e1e;
		  --focus: #3f8cff;
		  --button-bg: #3f8cff;
		  --button-bg-hover: #2f6edb;
		  --mono-output: #9fe89f;
		}
	  }
	  
	  /* 3) (Optional) Manual override: add data-theme="light|dark" on <html> */
	  html[data-theme="light"] {
		--bg: #ffffff;
		--text: #111111;
		--muted: #666666;
		--panel: #f5f5f7;
		--border: #d0d0d0;
		--input-bg: #ffffff;
		--mono-output: #0b5;
	  }
	  html[data-theme="dark"] {
		--bg: #121212;
		--text: #e0e0e0;
		--muted: #bbbbbb;
		--panel: #1a1a1a;
		--border: #333333;
		--input-bg: #1e1e1e;
		--mono-output: #9fe89f;
	  }
	  
	  /* 4) Component styles using the variables */
	  * { box-sizing: border-box; }
	  
	  body {
		margin: 0;
		font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
		background: var(--bg);
		color: var(--text);
		line-height: 1.5;
		padding: 1.25rem;
	  }
	  
	  h1, h2, h3 { color: var(--text); font-weight: 600; margin: 0 0 0.5rem; }
	  
	  form {
		margin-top: 1.25rem;
		display: flex;
		flex-direction: column;
		gap: 0.75rem;
	  }
	  
	  label { font-size: 0.9rem; color: var(--muted); }
	  
	  input[type="text"],
	  input[type="search"],
	  input[type="url"],
	  input[type="email"],
	  input[type="password"],
	  input[type="number"] {
		padding: 0.6rem 0.7rem;
		border: 1px solid var(--border);
		border-radius: 6px;
		background: var(--input-bg);
		color: var(--text);
	  }
	  
	  input:focus {
		outline: 2px solid var(--focus);
		border-color: var(--focus);
	  }
	  
	  button {
		padding: 0.6rem 1rem;
		background: var(--button-bg);
		border: none;
		border-radius: 6px;
		color: #fff;
		font-weight: 600;
		cursor: pointer;
		transition: background-color .15s ease-in-out, transform .02s ease-in-out;
	  }
	  button:hover { background: var(--button-bg-hover); }
	  button:active { transform: translateY(1px); }
	  
	  output#result {
		margin: 0;
		padding: 1rem;
		
		border-radius: 8px;
		font-size: 2rem;
		color: var(--mono-output);
		white-space: pre-wrap;
		word-break: break-word;
	  }
	  
	  .loading {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		margin-top: 0.5rem;
		color: var(--muted);
	  }
	  
	  .spinner {
		width: 1rem;
		height: 1rem;
		border: 2px solid var(--border);
		border-top-color: var(--focus);
		border-radius: 50%;
		animation: spin 0.7s linear infinite;
	  }
	  
	  @keyframes spin { to { transform: rotate(360deg); } }
	  
	  .hidden {
		display: none !important;
	  }
	  
	  #q {
		  font-size:2em;
		  font-weight:bold;
		  width: 100%;
		  border-radius: 8px;
		  padding: 1rem;
	  }
	  
	  .error-message {
		color: #e74c3c; /* red tone */
	  }
  </style>
</head>
<body>
	<main id="main">
  <h1>KLM Calculator</h1>
  <form id="klm-form">	
  <div style="display: grid;grid-template-columns: 3fr 1fr;">
	<div>
		<input id="q" name="q" size="30" required value="M P B" autocomplete="off" spellcheck="false" ria-describedby="error">  
		<div id="error" class="error-message" role="alert" aria-live="assertive"></div>
	</div>
	<div>
		<!-- Polite status for async work -->
		  <div id="loading" class="loading hidden" role="status" aria-live="polite" aria-atomic="true">
			<span class="spinner" aria-hidden="true"></span>
			<span class="loading-text">Calculatingâ€¦</span>
		  </div>
		<output id="result" aria-live="polite"></output>
	</div>
  </div>
  <button>Estimate</button>
  </form>
  <script>
	// Debounce utility (waits 'ms' after the last call)
	function debounce(fn, ms) {
	  let t;
	  return (...args) => {
		clearTimeout(t);
		t = setTimeout(() => fn(...args), ms);
	  };
	}
  
	const form   = document.getElementById('klm-form');
	const input  = document.getElementById('q');
	const result = document.getElementById('result');
	const loading = document.getElementById('loading');
  
	let currentController = null; // AbortController to cancel in-flight requests
  
	function setLoading(isLoading) {
	  if (isLoading) {
		loading.classList.remove("hidden");
	  } else {
		loading.classList.add("hidden");
	  }
	}
  
	async function estimate(q) {
	  if (!q) {
		if (currentController) currentController.abort();
		setLoading(false);
		clearError();
		result.textContent = '';
		return;
	  }
	
	  if (currentController) currentController.abort();
	  currentController = new AbortController();
	
	const error = document.getElementById('error');
	
	function showError(msg) {
	  input.setAttribute('aria-invalid', 'true');
	  error.textContent = msg || '';
	  result.textContent = '';        // clear estimate on error
	}
	
	function clearError() {
	  input.removeAttribute('aria-invalid');
	  error.textContent = '';
	}
	
	  setLoading(true);
	  clearError();
	
	  try {
		const res = await fetch(`/api/klm?q=${encodeURIComponent(q)}`, {
		  signal: currentController.signal
		});
		const data = await res.json().catch(() => ({}));
	
		if (!res.ok) {
		  showError(data.message || `Error: ${res.status} ${res.statusText}`);
		} else if (typeof data.estimatedTime === 'number') {
		  result.textContent = `${data.estimatedTime.toFixed(3)}s`;
		} else {
		  showError('No estimate returned.');
		}
	  } catch (err) {
		if (err.name !== 'AbortError') {
		  showError(`Network error: ${err}`);
		}
	  } finally {
		setLoading(false);
	  }
	}
  
	// Submit still works (Enter key / button), but routes through the same estimator
	form.addEventListener('submit', (e) => {
	  e.preventDefault();
	  estimate(input.value.trim());
	});
  
	// Live estimates while typing (debounced)
	const debouncedEstimate = debounce(() => estimate(input.value.trim()), 250);
	input.addEventListener('input', debouncedEstimate);
  
	// Optional: run once on page load if there's a preset value
	if (input.value.trim()) {
	  estimate(input.value.trim());
	}
  </script>
</body>
</html>